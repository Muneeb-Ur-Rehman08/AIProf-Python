<div id="assistantChat" class="hidden w-full md:w-1/2 flex flex-col justify-between"
_="on load if window.innerWidth > 768 then remove .hidden from me end"
>
    <!-- Chat Container -->
    <div class="flex-1 flex flex-col p-4 md:p-6 overflow-y-auto" id="chat-container">
        <!-- Messages will be dynamically inserted here -->
    </div>

    <!-- Message Input Area -->
    <div class="bg-black/30 p-3 md:p-4 w-full" style="border-top: 1px solid var(--clr-main)">
        <div class="max-w-4xl mx-auto flex gap-2">
            <!-- <button class="p-2 md:p-3 rounded bg-white/10 hover:bg-white/20 transition-colors text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                </svg>
            </button> -->
            
            <input 
                type="text"
                name="prompt"
                id="prompt-input"
                class="flex-1 bg-white/10 rounded px-3 md:px-4 py-2 md:py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2"
                placeholder="Type your message here..."
            >
            
            <button 
                class="p-2 md:p-3 rounded transition-colors duration-200"
                style="background: var(--clr-main); border: 1px solid var(--clr-main); color: white;"
                onmouseover="this.style.backgroundColor='#0890cc'" 
                onmouseout="this.style.backgroundColor='var(--clr-main)'"
                onclick="sendPayload()"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
    window.addEventListener('resize', () => {
        if (window.innerWidth >= 768) {
            document.getElementById('assistantChat').classList.remove('hidden');
            document.getElementById('assistantForm').classList.remove('hidden');

        } else {
            document.getElementById('assistantChat').classList.add('hidden');
        }
    });

    function appendMessage(text, isUser = false) {
        if (isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `w-full text-right mb-4`;
            messageDiv.innerHTML = `
                <div class="inline-block bg-blue-600 rounded-lg p-3 text-white max-w-[80%]">
                    ${text}
                </div>
            `;
            document.getElementById('chat-container').appendChild(messageDiv);
        } else {
            let assistantMessageDiv = document.querySelector('.assistant-message-pending');
            if (!assistantMessageDiv) {
                assistantMessageDiv = document.createElement('div');
                assistantMessageDiv.className = `w-full text-left mb-4 assistant-message-pending`;
                assistantMessageDiv.innerHTML = `
                    <div class="inline-block bg-white/10 rounded-lg p-3 text-white max-w-[80%]">
                        ${text}
                    </div>
                `;
                document.getElementById('chat-container').appendChild(assistantMessageDiv);
            } else {
                const messageContent = assistantMessageDiv.querySelector('div');
                messageContent.textContent += text;
            }
        }
        
        const chatContainer = document.getElementById('chat-container');
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function sendPayload() {
        const promptInput = document.getElementById('prompt-input');
        const promptValue = promptInput.value.trim();
        
        if (!promptValue) return;
        
        appendMessage(promptValue, true);
        
        promptInput.value = '';

        const payload = {
            conversation_id: '{{ assistant.id }}',
            message: promptValue,
            assistant_id: '{{ assistant.id }}'
        };

        const existingPending = document.querySelector('.assistant-message-pending');
        if (existingPending) {
            existingPending.classList.remove('assistant-message-pending');
        }

        fetch('/assistantchat/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'HX-Request': 'true'
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            const reader = response.body.getReader();
            let accumulatedResponse = '';
            
            function processStream({ done, value }) {
                if (done) {
                    const pendingMessage = document.querySelector('.assistant-message-pending');
                    if (pendingMessage) {
                        pendingMessage.classList.remove('assistant-message-pending');
                    }
                    return;
                }
                
                const chunk = new TextDecoder().decode(value);
                appendMessage(chunk, false);
                
                return reader.read().then(processStream);
            }
            
            return reader.read().then(processStream);
        })
        .catch(error => {
            console.error('Error:', error);
            appendMessage('Error: Failed to get response', false);
        });
    }
</script>
